#include <stdint.h>
#include <stddef.h>

#include "mode.h"
#include "defs.h"

// register database from SeaBIOS: vgasrc/stdvgamodes.c

static const uint8_t sequ_01[] = {
    0x08, 0x03, 0x00, 0x02
};
static const uint8_t crtc_01[] = {
    0x2d, 0x27, 0x28, 0x90, 0x2b, 0xa0, 0xbf, 0x1f,
    0x00, 0x4f, 0x0d, 0x0e, 0x00, 0x00, 0x00, 0x00,
    0x9c, 0x8e, 0x8f, 0x14, 0x1f, 0x96, 0xb9, 0xa3,
    0xff
};
static const uint8_t attr_01[] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
    0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f,
    0x0c, 0x00, 0x0f, 0x08
};
static const uint8_t gra_01[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0e, 0x0f, 0xff
};

static const uint8_t sequ_03[] = {
    0x00, 0x03, 0x00, 0x02
};
static const uint8_t crtc_03[] = {
    0x5f, 0x4f, 0x50, 0x82, 0x55, 0x81, 0xbf, 0x1f,
    0x00, 0x4f, 0x0d, 0x0e, 0x00, 0x00, 0x00, 0x00,
    0x9c, 0x8e, 0x8f, 0x28, 0x1f, 0x96, 0xb9, 0xa3,
    0xff
};

static const uint8_t sequ_04[] = {
    0x09, 0x03, 0x00, 0x02
};
static const uint8_t crtc_04[] = {
    0x2d, 0x27, 0x28, 0x90, 0x2b, 0x80, 0xbf, 0x1f,
    0x00, 0xc1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x9c, 0x8e, 0x8f, 0x14, 0x00, 0x96, 0xb9, 0xa2,
    0xff
};
static const uint8_t attr_04[] = {
    0x00, 0x13, 0x15, 0x17, 0x02, 0x04, 0x06, 0x07,
    0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
    0x01, 0x00, 0x03, 0x00
};
static const uint8_t gra_04[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x0f, 0x0f, 0xff
};
static const uint8_t sequ_06[] = {
    0x01, 0x01, 0x00, 0x06
};
static const uint8_t crtc_06[] = {
    0x5f, 0x4f, 0x50, 0x82, 0x54, 0x80, 0xbf, 0x1f,
    0x00, 0xc1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x9c, 0x8e, 0x8f, 0x28, 0x00, 0x96, 0xb9, 0xc2,
    0xff
};
static const uint8_t attr_06[] = {
    0x00, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17,
    0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17,
    0x01, 0x00, 0x01, 0x00
};
static const uint8_t gra_06[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x0f, 0xff
};
static const uint8_t crtc_07[] = {
    0x5f, 0x4f, 0x50, 0x82, 0x55, 0x81, 0xbf, 0x1f,
    0x00, 0x4f, 0x0d, 0x0e, 0x00, 0x00, 0x00, 0x00,
    0x9c, 0x8e, 0x8f, 0x28, 0x0f, 0x96, 0xb9, 0xa3,
    0xff
};
static const uint8_t attr_07[] = {
    0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x10, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
    0x0e, 0x00, 0x0f, 0x08
};
static const uint8_t gra_07[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0a, 0x0f, 0xff
};
static const uint8_t sequ_0d[] = {
    0x09, 0x0f, 0x00, 0x06
};
static const uint8_t crtc_0d[] = {
    0x2d, 0x27, 0x28, 0x90, 0x2b, 0x80, 0xbf, 0x1f,
    0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x9c, 0x8e, 0x8f, 0x14, 0x00, 0x96, 0xb9, 0xe3,
    0xff
};
static const uint8_t attr_0d[] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
    0x01, 0x00, 0x0f, 0x00
};
static const uint8_t gra_0d[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x0f, 0xff
};
static const uint8_t sequ_0e[] = {
    0x01, 0x0f, 0x00, 0x06
};
static const uint8_t crtc_0e[] = {
    0x5f, 0x4f, 0x50, 0x82, 0x54, 0x80, 0xbf, 0x1f,
    0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x9c, 0x8e, 0x8f, 0x28, 0x00, 0x96, 0xb9, 0xe3,
    0xff
};
static const uint8_t crtc_0f[] = {
    0x5f, 0x4f, 0x50, 0x82, 0x54, 0x80, 0xbf, 0x1f,
    0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x83, 0x85, 0x5d, 0x28, 0x0f, 0x63, 0xba, 0xe3,
    0xff
};
static const uint8_t attr_0f[] = {
    0x00, 0x08, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
    0x00, 0x08, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00,
    0x01, 0x00, 0x01, 0x00
};
static const uint8_t attr_10[] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
    0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f,
    0x01, 0x00, 0x0f, 0x00
};
static const uint8_t crtc_11[] = {
    0x5f, 0x4f, 0x50, 0x82, 0x54, 0x80, 0x0b, 0x3e,
    0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xea, 0x8c, 0xdf, 0x28, 0x00, 0xe7, 0x04, 0xe3,
    0xff
};
static const uint8_t attr_11[] = {
    0x00, 0x3f, 0x00, 0x3f, 0x00, 0x3f, 0x00, 0x3f,
    0x00, 0x3f, 0x00, 0x3f, 0x00, 0x3f, 0x00, 0x3f,
    0x01, 0x00, 0x0f, 0x00
};
static const uint8_t sequ_13[] = {
    0x01, 0x0f, 0x00, 0x0e
};
static const uint8_t crtc_13[] = {
    0x5f, 0x4f, 0x50, 0x82, 0x54, 0x80, 0xbf, 0x1f,
    0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x9c, 0x8e, 0x8f, 0x28, 0x40, 0x96, 0xb9, 0xa3,
    0xff
};
static const uint8_t attr_13[] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
    0x41, 0x00, 0x0f, 0x00
};
static const uint8_t gra_13[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0f, 0xff
};
static const uint8_t crtc_6A[] = {
    0x7f, 0x63, 0x63, 0x83, 0x6b, 0x1b, 0x72, 0xf0,
    0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x59, 0x8d, 0x57, 0x32, 0x00, 0x57, 0x73, 0xe3,
    0xff
};

static const struct video_mode vga_modes[] = {
    //  mode  info
    //  misc  seq      crtc     gra     attr
    {
        0x00, { MM_TEXT, 40, 25, 4, 9, 16, 0xB800 },
        0x67, sequ_01, crtc_01, gra_01, attr_01
    },
    {
        0x01, { MM_TEXT, 40, 25, 4, 9, 16, 0xB800 },
        0x67, sequ_01, crtc_01, gra_01, attr_01
    },
    {
        0x02, { MM_TEXT, 80, 25, 4, 9, 16, 0xB800 },
        0x67, sequ_03, crtc_03, gra_01, attr_01
    },
    {
        0x03, { MM_TEXT, 80, 25, 4, 9, 16, 0xB800 },
        0x67, sequ_03, crtc_03, gra_01, attr_01
    },
    {
        0x04, { MM_CGA, 320, 200, 2, 8, 8, 0xB800 },
        0x63, sequ_04, crtc_04, gra_04, attr_04
    },
    {
        0x05, { MM_CGA, 320, 200, 2, 8, 8, 0xB800 },
        0x63, sequ_04, crtc_04, gra_04, attr_04
    },
    {
        0x06, { MM_CGA, 640, 200, 1, 8, 8, 0xB800 },
        0x63, sequ_06, crtc_06, gra_06, attr_06
    },
    {
        0x07, { MM_TEXT, 8, 25, 4, 9, 16, 0xB000 },
        0x66, sequ_03, crtc_07, gra_07, attr_07
    },
    {
        0x0D, { MM_PLANAR, 320, 200, 4, 8, 8, 0xA000 },
        0x63, sequ_0d, crtc_0d, gra_0d, attr_0d
    },
    {
        0x0E, { MM_PLANAR, 640, 200, 4, 8, 8, 0xA000 },
        0x63, sequ_0e, crtc_0e, gra_0d, attr_0d
    },
    {
        0x0F, { MM_PLANAR, 640, 350, 1, 8, 14, 0xA000 },
        0xA3, sequ_0e, crtc_0f, gra_0d, attr_0f
    },
    {
        0x10, { MM_PLANAR, 640, 350, 4, 8, 14, 0xA000 },
        0xA3, sequ_0e, crtc_0f, gra_0d, attr_10
    },
    {
        0x11, { MM_PLANAR, 640, 480, 1, 8, 14, 0xA000 },
        0xE3, sequ_0e, crtc_11, gra_0d, attr_11
    },
    {
        0x12, { MM_PLANAR, 640, 480, 4, 8, 14, 0xA000 },
        0xE3, sequ_0e, crtc_11, gra_0d, attr_10
    },
    {
        0x13, { MM_PACKED, 320, 200, 8, 8, 8, 0xA000 },
        0x63, sequ_13, crtc_13, gra_13, attr_13
    },
    {
        0x6A, { MM_PLANAR, 800, 600, 4, 8, 14, 0xA000 },
        0xE3, sequ_0e, crtc_6A, gra_0d, attr_10
    },
    END_OF_VMODE_TABLE
};

static void clear_screen(const struct video_mode* mode)
{
    switch (mode->info.mmodel) {
    case MM_TEXT:
        memset16(mode->info.buf_base, 0x0720, 32*1024);
        break;
    case MM_CGA:
        memset16(mode->info.buf_base, 0x0000, 32*1024);
        break;
    default:
        memset16(mode->info.buf_base, 0x0000, 64*1024);
    }
}

static const struct video_mode *find_mode(int mode)
{
    for (int i = 0; i < ARR_SIZE(vga_modes); i++) {
        if (vga_modes[i].mode == mode) {
            return &vga_modes[i];
        }
    }
    return NULL;
}

static int set_mode(const struct video_mode *mode)
{
    miscreg_write(mode->miscreg);

    uint8_t* data = mode->sequencer;
    vga_sequencer_write(0x00, 0x03);
    for (int i = 0; i < 4; i++) {
        sequencer_write(i + 1, data[i]);
    }

    data = mode->attribute;
    for (int i = 0; i < 20; i++) {
        attribute_write(i, data[i]);
    }

    data = mode->graphics;
    for (int i = 0; i < 9; i++) {
        graphics_write(i, data[i]);
    }

    data = mode->crtc;
    if (!(mode->miscreg & 1)) {
        crtc_mda_write(0x11, 0x00);

        for (int i = 0; i < 25; i++) {
            crtc_mda_write(i, data[i]);
        }
    } else {
        crtc_vga_write(0x11, 0x00);

        for (int i = 0; i < 25; i++) {
            crtc_vga_write(i, data[i]);
        }
    }

    enable_video();

    clear_screen(mode);

    return 0;
}


